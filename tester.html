<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Peggle ‚Äì Portal Edition</title>

<style>
html,body{
  margin:0;padding:0;overflow:hidden;
  background:linear-gradient(180deg,#0a0e27,#16213e,#0f3460);
  font-family:'Arial Rounded MT Bold',Arial,sans-serif;
}
canvas{display:block}

#ui{
  position:fixed;top:15px;left:15px;
  background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(240,240,255,.9));
  padding:16px 20px;border-radius:12px;
  font-weight:bold;font-size:16px;
  box-shadow:0 8px 32px rgba(0,0,0,.3);
  border:2px solid rgba(255,255,255,.3);
  z-index:10;
}
#ui div{margin:4px 0}

#ballsDisplay{
  position:fixed;top:15px;right:15px;
  background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(240,240,255,.9));
  padding:12px;border-radius:12px;
  display:flex;gap:8px;
  box-shadow:0 8px 32px rgba(0,0,0,.3);
  border:2px solid rgba(255,255,255,.3);
  z-index:10;
}
.ballIcon{
  width:18px;height:18px;border-radius:50%;
  background:radial-gradient(circle at 30% 30%,#ff6b6b,#c92a2a);
  box-shadow:0 2px 8px rgba(255,0,0,.4);
  transition:all .2s;
}
.ballIcon.used{opacity:.15;transform:scale(.8)}

#menu,#overlay{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;
  z-index:100;
}
#menu{
  background:linear-gradient(135deg,#667eea,#764ba2,#f093fb);
}
#menu h1{
  color:white;font-size:72px;margin:30px;
  text-shadow:0 0 20px rgba(255,255,255,.5),0 0 40px rgba(255,100,255,.3);
  animation:titleFloat 3s ease-in-out infinite;
}
@keyframes titleFloat{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-10px)}
}

#overlay{
  display:none;
  background:rgba(0,0,0,.9);
  color:white;
}

.btn{
  padding:18px 45px;font-size:26px;border:none;
  border-radius:50px;cursor:pointer;
  background:linear-gradient(135deg,#f093fb,#f5576c);
  color:white;
  box-shadow:0 6px 25px rgba(245,87,108,.4);
  transition:all .2s;
  font-weight:bold;
  text-transform:uppercase;
}
.btn:hover{
  transform:scale(1.08) translateY(-2px);
  box-shadow:0 8px 35px rgba(245,87,108,.6);
}
.btn:active{transform:scale(.98)}

#bucketText{
  position:fixed;bottom:80px;left:50%;
  transform:translateX(-50%) scale(0);
  font-size:48px;font-weight:bold;
  color:#ffd700;opacity:0;
  transition:.4s;
  text-shadow:0 0 20px rgba(255,215,0,.8),0 0 40px rgba(255,215,0,.5);
  z-index:50;
}

#achievement{
  position:fixed;top:100px;right:-400px;
  background:linear-gradient(135deg,#ffd700,#ffed4e);
  padding:20px 25px;border-radius:15px;
  box-shadow:0 8px 32px rgba(0,0,0,.4);
  border:3px solid #fff;
  transition:right .5s cubic-bezier(.68,-.55,.265,1.55);
  z-index:150;
  min-width:320px;
}
#achievement.show{right:15px}
#achievement h3{
  margin:0 0 8px 0;
  font-size:22px;
  color:#7b2cbf;
  text-shadow:0 2px 4px rgba(0,0,0,.2);
}
#achievement p{
  margin:0;
  font-size:16px;
  color:#333;
}

#achievements{
  max-width:800px;
  margin:30px auto;
  padding:20px;
  background:rgba(255,255,255,.1);
  border-radius:15px;
  max-height:400px;
  overflow-y:auto;
}
#achievements h2{
  color:white;
  margin:0 0 20px 0;
  text-align:center;
}
.achievement-item{
  background:linear-gradient(135deg,rgba(255,255,255,.95),rgba(240,240,255,.9));
  padding:15px;
  margin:10px 0;
  border-radius:10px;
  display:flex;
  align-items:center;
  gap:15px;
  opacity:.4;
  border:2px solid rgba(255,255,255,.3);
}
.achievement-item.unlocked{
  opacity:1;
  border-color:#ffd700;
  box-shadow:0 4px 15px rgba(255,215,0,.3);
}
.achievement-icon{
  font-size:32px;
  min-width:40px;
  text-align:center;
}
.achievement-info h4{
  margin:0 0 5px 0;
  color:#7b2cbf;
  font-size:16px;
}
.achievement-info p{
  margin:0;
  color:#666;
  font-size:13px;
}
</style>
</head>

<body>

<div id="menu">
  <h1>üéØ PEGGLE PORTAL üéØ</h1>
  <button class="btn" onclick="startGame()">START GAME</button>
  <button class="btn" onclick="showAchievements()" style="margin-top:15px;font-size:20px;padding:12px 35px">üèÜ ACHIEVEMENTS</button>
  <div id="achievements" style="display:none"></div>
</div>

<div id="ui">
  <div style="color:#ff6600;font-size:18px">‚≠ê <span id="score">0</span></div>
  <div style="color:#ff8800">üü† <span id="orange">0</span> Left</div>
  <div style="color:#4da6ff">üéØ Level <span id="level">1</span></div>
</div>

<div id="ballsDisplay"></div>
<div id="bucketText">FREE BALL!</div>

<div id="achievement">
  <h3 id="achievementTitle"></h3>
  <p id="achievementDesc"></p>
</div>

<div id="overlay">
  <h1 id="overlayTitle"></h1>
  <p style="font-size:32px;margin:25px">Score: <span id="finalScore"></span></p>
  <button class="btn" onclick="overlayAction()">CONTINUE</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
function resize(){canvas.width=innerWidth;canvas.height=innerHeight}
resize();
addEventListener("resize",resize);

const GRAVITY=.35,REST=.985,POWER=18;

const uiScore=document.getElementById("score");
const uiOrange=document.getElementById("orange");
const uiLevel=document.getElementById("level");
const ballsDisplay=document.getElementById("ballsDisplay");
const overlay=document.getElementById("overlay");
const overlayTitle=document.getElementById("overlayTitle");
const finalScore=document.getElementById("finalScore");
const bucketText=document.getElementById("bucketText");
const achievementEl=document.getElementById("achievement");
const achievementTitle=document.getElementById("achievementTitle");
const achievementDesc=document.getElementById("achievementDesc");
const menu = document.getElementById("menu");

const ACHIEVEMENTS=[
  {id:"10k", icon:"üí∞", name:"Big Spender", desc:"Reach 10,000 points", unlocked:false},
  {id:"100k", icon:"üëë", name:"Peggle Royalty", desc:"Reach 100,000 points", unlocked:false},
  {id:"perfect", icon:"üíØ", name:"Perfectionist", desc:"Clear every single peg in a level", unlocked:false},
  {id:"ach_2", icon:"üéØ", name:"Bullseye", desc:"Hit a peg within 0.5s of firing", unlocked:false},
  {id:"ach_5", icon:"‚úåÔ∏è", name:"Double Tap", desc:"Hit two orange pegs in a row", unlocked:false},
  {id:"ach_8", icon:"üåÄ", name:"Infinite Loop", desc:"Use portals 5 times in one shot", unlocked:false},
  {id:"ach_9", icon:"‚ú®", name:"Interdimensional", desc:"Hit an orange peg right after a portal", unlocked:false},
  {id:"ach_12", icon:"üéí", name:"The Tourist", desc:"Visit both portals and the bucket in one turn", unlocked:false},
  {id:"ach_14", icon:"üî•", name:"Pyromaniac", desc:"Clear 15 pegs with one fireball", unlocked:false},
  {id:"ach_15", icon:"üíú", name:"Chain Reaction", desc:"Purple explosion hits 5+ pegs", unlocked:false},
  {id:"ach_16", icon:"üëê", name:"Crowd Control", desc:"Catch 3 balls in one level with Big Bucket", unlocked:false},
  {id:"ach_18", icon:"‚ò¢Ô∏è", name:"Nuclear Option", desc:"Clear 30% of the board in one shot", unlocked:false},
  {id:"ach_19", icon:"‚òØÔ∏è", name:"Efficient Energy", desc:"Hit Green and Orange in one shot", unlocked:false},
  {id:"ach_23", icon:"üÜò", name:"Clutch", desc:"Get a Free Ball with 0 balls remaining", unlocked:false},
  {id:"ach_26", icon:"üèÉ", name:"Speedrunner", desc:"Complete level in under 5 shots", unlocked:false},
  {id:"ach_27", icon:"üßπ", name:"Clean Sweep", desc:"Clear every single peg on the board", unlocked:false}
  
];

let unlockedAchievements=[];
let running=false;
let score=0,ballsLeft=10,level=1;
let pegs=[],balls=[],particles=[],portals=[];
let canShoot=true;
let multiballActive=false;
let pegsHitThisTurn=0;
let bucketExpanded=false,bucketTimer=0;
let slowmo=0,bgTime=0;
let zoomActive=false,zoomLevel=1,zoomTargetY=0;

// NEW TRACKING VARIABLES
let shotStartTime=0;
let lastPegType="";
let orangeHitsThisTurn=0;
let portalUsesThisTurn=0;
let justExitedPortal=false;
let bucketVisitsThisTurn=0;
let greenHitsThisTurn=0;
let fireballHitsThisTurn=0;
let bigBucketCatches=0;
let shotsThisLevel=0;
let specialTypesHitThisLevel=new Set();

const field={
  left:()=>canvas.width/2-400,
  right:()=>canvas.width/2+400,
  top:120
};

const bucket={x:0,w:120,vx:4};

let mouse={x:0,y:0};
canvas.addEventListener("mousemove",e=>{
  const r=canvas.getBoundingClientRect();
  mouse.x=e.clientX-r.left;
  mouse.y=e.clientY-r.top;
});
canvas.addEventListener("click",shoot);

addEventListener("keydown",e=>{
  if(e.code==="Space"&&running&&canShoot&&!balls.length){
    e.preventDefault();
    zoomActive=true;
  }
});

addEventListener("keyup",e=>{
  if(e.code==="Space"){
    zoomActive=false;
  }
});

let audio;
addEventListener("click",()=>{if(!audio)audio=new AudioContext()},{once:true});
function beep(f,d=.06,type="sine"){
  if(!audio)return;
  const o=audio.createOscillator(),g=audio.createGain();
  o.type=type;
  o.frequency.value=f;
  o.connect(g);
  g.connect(audio.destination);
  g.gain.setValueAtTime(.15,audio.currentTime);
  g.gain.exponentialRampToValueAtTime(.01,audio.currentTime+d);
  o.start();
  o.stop(audio.currentTime+d);
}

function drawBackground(){
  bgTime++;
  const grad=ctx.createLinearGradient(0,0,0,canvas.height);
  const time=bgTime*.0005;
  grad.addColorStop(0,`hsl(${230+Math.sin(time)*10},45%,${15+Math.sin(time*2)*3}%)`);
  grad.addColorStop(.5,`hsl(${250+Math.cos(time*.7)*10},50%,${20+Math.cos(time*1.5)*3}%)`);
  grad.addColorStop(1,`hsl(${210+Math.sin(time*.5)*10},40%,${12+Math.sin(time)*2}%)`);
  ctx.fillStyle=grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);
  
  for(let i=0;i<30;i++){
    const x=(i*50+time*20)%canvas.width;
    const y=100+Math.sin(time+i)*40;
    ctx.beginPath();
    ctx.arc(x,y,2,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${.1+Math.sin(time*2+i)*.05})`;
    ctx.fill();
  }
}

function generateLevel(){
  pegs=[];
  balls=[];
  particles=[];
  bucket.x=field.left();
  multiballActive=false;
  slowmo=0;
  specialTypesHitThisLevel.clear();
  shotsThisLevel=0;
  bigBucketCatches=0;
  
  const padding=80;
  const spawnPortal=()=>({
    x:field.left()+padding+Math.random()*(800-padding*2),
    y:field.top+100+Math.random()*(canvas.height-field.top-300),
    r:28
  });

  const p1=spawnPortal();
  const p2=spawnPortal();
  
  while(Math.hypot(p1.x-p2.x,p1.y-p2.y)<200){
    p2.x=field.left()+padding+Math.random()*(800-padding*2);
    p2.y=field.top+100+Math.random()*(canvas.height-field.top-300);
  }

  portals=[
    {x:p1.x,y:p1.y,tx:p2.x,ty:p2.y,r:p1.r,pulse:0},
    {x:p2.x,y:p2.y,tx:p1.x,ty:p1.y,r:p2.r,pulse:Math.PI}
  ];
  
  for(let r=0;r<9;r++){
    for(let c=0;c<10;c++){
      if(Math.random()<.1)continue;
      
      const px=field.left()+80+c*75+(r%2)*37;
      const py=field.top+r*60;
      const nearPortal=portals.some(port=>Math.hypot(px-port.x,py-port.y)<50);
      
      if(!nearPortal){
        pegs.push({
          x:px,y:py,r:9,
          hit:false,type:"blue",wobble:0,
          pulse:Math.random()*Math.PI*2
        });
      }
    }
  }
  
  shuffle(pegs);
  pegs.slice(0,Math.floor(pegs.length*.2)).forEach(p=>p.type="orange");
  
  const specialPegs=pegs.filter(p=>p.type==="blue");
  shuffle(specialPegs);
  specialPegs.slice(0,2).forEach(p=>p.type="green");
  specialPegs.slice(2,4).forEach(p=>p.type="purple");
  specialPegs.slice(4,6).forEach(p=>p.type="multiball");
  specialPegs.slice(6,8).forEach(p=>p.type="fireball");
  
  updateUI();
}

function shoot(){
  if(!running||!canShoot||balls.length||ballsLeft<=0)return;
  ballsLeft--;
  canShoot=false;
  
  // RESET SHOT STATS
  shotStartTime=Date.now();
  pegsHitThisTurn=0;
  portalUsesThisTurn=0;
  orangeHitsThisTurn=0;
  greenHitsThisTurn=0;
  fireballHitsThisTurn=0;
  bucketVisitsThisTurn=0;
  lastPegType="";
  justExitedPortal=false;
  shotsThisLevel++;
  
  const a=Math.atan2(mouse.y-60,mouse.x-canvas.width/2);
  balls.push({
    x:canvas.width/2,y:60,
    vx:Math.cos(a)*POWER,
    vy:Math.sin(a)*POWER,
    r:8,trail:[],bucketed:false,
    fireball:false,portalCooldown:0
  });
  
  if(multiballActive){
    for(let i=0;i<2;i++){
      const offset=(i===0?-.15:.15);
      balls.push({
        x:canvas.width/2,y:60,
        vx:Math.cos(a+offset)*POWER,
        vy:Math.sin(a+offset)*POWER,
        r:8,trail:[],bucketed:false,
        fireball:false,portalCooldown:0
      });
    }
    multiballActive=false;
  }
  
  beep(400,.08,"square");
  updateUI();
}

function endTurn(){
  // TRIGGER END-OF-TURN ACHIEVEMENTS
  if(portalUsesThisTurn >= 5) unlockAchievement("ach_8");
  if(portalUsesThisTurn > 0 && bucketVisitsThisTurn > 0) unlockAchievement("ach_12");
  if(ballsLeft === 0 && bucketVisitsThisTurn > 0) unlockAchievement("ach_23");
  
  const initialTotal = pegs.length;
  const boardClearPercent = pegsHitThisTurn / (pegs.length + pegsHitThisTurn);
  if(boardClearPercent >= 0.3) unlockAchievement("ach_18");

  canShoot=true;
  const hitAllPegs=pegs.every(p=>p.hit);
  pegs=pegs.filter(p=>!p.hit);
  balls=[];

  setTimeout(()=>{
    if(!pegs.some(p=>p.type==="orange")){
      if(shotsThisLevel <= 5) unlockAchievement("ach_26");
      if(pegs.length === 0) unlockAchievement("ach_27");
      if(hitAllPegs) unlockAchievement("perfect");
      showOverlay("üéä LEVEL COMPLETE! üéä");
    }else if(ballsLeft<=0){
      showOverlay("üíÄ GAME OVER üíÄ");
    }
  },100);
}

function collide(b,p){
  if(p.hit)return;
  const dx=b.x-p.x,dy=b.y-p.y,d=Math.hypot(dx,dy);
  if(d<b.r+p.r){
    p.hit=true;
    p.wobble=.7;
    pegsHitThisTurn++;
    
    // ACH 2: BULLSEYE
    if(Date.now() - shotStartTime < 500) unlockAchievement("ach_2");

    // ACH 9: INTERDIMENSIONAL
    if(justExitedPortal && p.type === "orange") unlockAchievement("ach_9");
    justExitedPortal = false;

    // ACH 5: DOUBLE TAP
    if(p.type === "orange") {
        if(lastPegType === "orange") unlockAchievement("ach_5");
        orangeHitsThisTurn++;
    }
    lastPegType = p.type;

    // ACH 19: EFFICIENT ENERGY
    if(p.type === "green") greenHitsThisTurn++;
    if(greenHitsThisTurn > 0 && orangeHitsThisTurn > 0) unlockAchievement("ach_19");

    if(p.type!=="blue") specialTypesHitThisLevel.add(p.type);
    
    const pts=p.type==="orange"?100:p.type==="green"?500:p.type==="purple"?1000:p.type==="multiball"?250:p.type==="fireball"?250:10;
    score+=pts;
    
    const nx=dx/(d||1),ny=dy/(d||1);
    const dot=b.vx*nx+b.vy*ny;
    b.vx-=2.2*dot*nx;
    b.vy-=2.2*dot*ny;
    
    const overlap=b.r+p.r-d;
    b.x+=nx*overlap;
    b.y+=ny*overlap;
    
    if(p.type==="orange")beep(900,.12,"sine");
    else if(p.type==="green")beep(1100,.12,"triangle");
    else if(p.type==="purple")beep(1200,.15,"sawtooth");
    else if(p.type==="multiball")beep(800,.1,"square");
    else if(p.type==="fireball")beep(950,.12,"triangle");
    else beep(500,.08,"sine");
    
    const color=p.type==="orange"?"#ff8800":p.type==="green"?"#00ff66":p.type==="purple"?"#9d4edd":p.type==="multiball"?"#00d9ff":p.type==="fireball"?"#ff3300":"#4da6ff";
    for(let i=0;i<25;i++){
      particles.push({
        x:p.x,y:p.y,
        vx:(Math.random()-.5)*10,
        vy:(Math.random()-.5)*10-3,
        life:50,color,size:2+Math.random()*2
      });
    }
    
    if(p.type==="green"){
      bucketExpanded=true;
      bucketTimer=900;
    }
    
    if(p.type==="purple"){
      const nearPegs=pegs.filter(np=>!np.hit&&Math.hypot(np.x-p.x,np.y-p.y)<120);
      // ACH 15: CHAIN REACTION
      if(nearPegs.length >= 5) unlockAchievement("ach_15");
      nearPegs.forEach(np=>{
        np.hit=true;
        pegsHitThisTurn++;
        if(np.type!=="blue") specialTypesHitThisLevel.add(np.type);
        score+=np.type==="orange"?100:10;
        for(let i=0;i<20;i++){
          particles.push({
            x:np.x,y:np.y,
            vx:(Math.random()-.5)*8,
            vy:(Math.random()-.5)*8-2,
            life:45,
            color:np.type==="orange"?"#ff8800":"#4da6ff",
            size:2
          });
        }
      });
    }
    
    if(p.type==="multiball")multiballActive=true;
    if(p.type==="fireball")b.fireball=true;
    
    if(p.type==="orange"){
      const remainingOrange=pegs.filter(pg=>pg.type==="orange"&&!pg.hit).length;
      if(remainingOrange===0) slowmo=120;
    }
    
    updateUI();
  }
}

function loop(){
  if(!running)return;
  const dt=slowmo>0?.25:1;
  if(slowmo>0)slowmo--;
  const targetZoom=zoomActive?2:1;
  zoomLevel+=(targetZoom-zoomLevel)*.15;
  if(zoomActive){ zoomTargetY+=(200-zoomTargetY)*.15; }else{ zoomTargetY+=(0-zoomTargetY)*.15; }
  
  ctx.save();
  ctx.translate(canvas.width/2,zoomTargetY);
  ctx.scale(zoomLevel,zoomLevel);
  ctx.translate(-canvas.width/2,-zoomTargetY);
  
  drawBackground();

  if(canShoot&&!balls.length){
    let a=Math.atan2(mouse.y-60,mouse.x-canvas.width/2);
    let px=canvas.width/2,py=60;
    let vx=Math.cos(a)*POWER,vy=Math.sin(a)*POWER;
    for(let i=0;i<60;i++){
      vy+=GRAVITY;px+=vx;py+=vy;
      vx*=REST;vy*=REST;
      if(px<field.left()+8||px>field.right()-8)vx*=-1;
      if(py<8)vy*=-1;
      if(i%3===0){
        ctx.globalAlpha=.5*(1-i/60);
        ctx.beginPath();
        ctx.arc(px,py,3,0,Math.PI*2);
        ctx.fillStyle="rgba(255,255,255,.8)";
        ctx.shadowColor="rgba(255,255,255,.5)";
        ctx.shadowBlur=5;
        ctx.fill();
        ctx.shadowBlur=0;
      }
    }
    ctx.globalAlpha=1;
  }

  if(!balls.length&&ballsLeft>0){
    const a=Math.atan2(mouse.y-60,mouse.x-canvas.width/2);
    ctx.save();
    ctx.translate(canvas.width/2,60);
    ctx.rotate(a);
    const cannonGrad=ctx.createLinearGradient(0,-10,0,10);
    cannonGrad.addColorStop(0,"#666");
    cannonGrad.addColorStop(1,"#333");
    ctx.fillStyle=cannonGrad;
    ctx.fillRect(-15,-10,45,20);
    const baseGrad=ctx.createRadialGradient(0,0,5,0,0,22);
    baseGrad.addColorStop(0,"#888");
    baseGrad.addColorStop(1,"#444");
    ctx.beginPath();
    ctx.arc(0,0,22,0,Math.PI*2);
    ctx.fillStyle=baseGrad;
    ctx.fill();
    ctx.strokeStyle="#222";
    ctx.lineWidth=2;
    ctx.stroke();
    ctx.restore();
  }

  const wallGrad=ctx.createLinearGradient(field.left()-15,0,field.left()+5,0);
  wallGrad.addColorStop(0,"#1a1a3e");
  wallGrad.addColorStop(1,"#2a2a4e");
  ctx.fillStyle=wallGrad;
  ctx.shadowColor="rgba(0,0,0,.5)";
  ctx.shadowBlur=15;
  ctx.fillRect(field.left()-15,field.top,15,canvas.height);
  ctx.fillRect(field.right(),field.top,15,canvas.height);
  ctx.shadowBlur=0;

  portals.forEach(p=>{
    p.pulse+=.05;
    const pulseSize=p.r+(Math.sin(p.pulse)*3);
    ctx.beginPath();
    ctx.arc(p.x,p.y,pulseSize,0,Math.PI*2);
    const portalGrad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,pulseSize);
    portalGrad.addColorStop(0,"rgba(160,32,240,.3)");
    portalGrad.addColorStop(.5,"rgba(160,32,240,.1)");
    portalGrad.addColorStop(1,"rgba(160,32,240,0)");
    ctx.fillStyle=portalGrad;
    ctx.fill();
    ctx.strokeStyle="#a020f0";
    ctx.lineWidth=4;
    ctx.shadowColor="#a020f0";
    ctx.shadowBlur=20;
    ctx.setLineDash([8,8]);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.shadowBlur=0;
  });

  pegs.forEach(p=>{
    if(p.hit&&p.wobble<.05)return;
    p.wobble*=.88;
    p.pulse+=.05;
    ctx.save();
    ctx.translate(p.x,p.y);
    ctx.rotate(p.wobble);
    if(p.hit)ctx.globalAlpha=Math.max(.3,p.wobble*2);
    const pulseSize=p.r+(Math.sin(p.pulse)*.5);
    ctx.beginPath();
    ctx.arc(0,0,pulseSize,0,Math.PI*2);
    
    if(p.type==="orange"){
      ctx.shadowColor="#ff8800"; ctx.shadowBlur=15;
      const grad=ctx.createRadialGradient(-3,-3,0,0,0,pulseSize);
      grad.addColorStop(0,"#ffaa44"); grad.addColorStop(.5,"#ff8800"); grad.addColorStop(1,"#ff6600");
      ctx.fillStyle=grad;
    }else if(p.type==="green"){
      ctx.shadowColor="#00ff66"; ctx.shadowBlur=15;
      const grad=ctx.createRadialGradient(-3,-3,0,0,0,pulseSize);
      grad.addColorStop(0,"#88ff88"); grad.addColorStop(.5,"#00ff66"); grad.addColorStop(1,"#00cc00");
      ctx.fillStyle=grad;
    }else if(p.type==="purple"){
      ctx.shadowColor="#9d4edd"; ctx.shadowBlur=18;
      const grad=ctx.createRadialGradient(-3,-3,0,0,0,pulseSize);
      grad.addColorStop(0,"#e0aaff"); grad.addColorStop(.5,"#c77dff"); grad.addColorStop(1,"#7b2cbf");
      ctx.fillStyle=grad;
    }else if(p.type==="multiball"){
      ctx.shadowColor="#00d9ff"; ctx.shadowBlur=15;
      const grad=ctx.createRadialGradient(-3,-3,0,0,0,pulseSize);
      grad.addColorStop(0,"#88e0ff"); grad.addColorStop(.5,"#00d9ff"); grad.addColorStop(1,"#0099cc");
      ctx.fillStyle=grad;
    }else if(p.type==="fireball"){
      ctx.shadowColor="#ff3300"; ctx.shadowBlur=18;
      const grad=ctx.createRadialGradient(-3,-3,0,0,0,pulseSize);
      grad.addColorStop(0,"#ff9966"); grad.addColorStop(.5,"#ff6633"); grad.addColorStop(1,"#cc0000");
      ctx.fillStyle=grad;
    }else{
      const grad=ctx.createRadialGradient(-3,-3,0,0,0,pulseSize);
      grad.addColorStop(0,"#6db3ff"); grad.addColorStop(.5,"#4da6ff"); grad.addColorStop(1,"#1e70dd");
      ctx.fillStyle=grad;
    }
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.globalAlpha=1;
    ctx.restore();
  });

  particles=particles.filter(pt=>{
    pt.life--;
    pt.x+=pt.vx*dt;
    pt.y+=pt.vy*dt;
    pt.vy+=GRAVITY*.3*dt;
    pt.vx*=.98;
    ctx.globalAlpha=pt.life/50;
    ctx.fillStyle=pt.color;
    ctx.shadowColor=pt.color;
    ctx.shadowBlur=8;
    ctx.beginPath();
    ctx.arc(pt.x,pt.y,pt.size,0,Math.PI*2);
    ctx.fill();
    ctx.shadowBlur=0;
    ctx.globalAlpha=1;
    return pt.life>0;
  });

  bucket.x+=bucket.vx*dt;
  if(bucket.x<field.left()||bucket.x>field.right()-bucket.w)bucket.vx*=-1;
  const by=canvas.height-35;
  if(bucketExpanded){
    bucketTimer--;
    if(bucketTimer<=0)bucketExpanded=false;
  }
  const currentBucketW=bucketExpanded?bucket.w+80:bucket.w;
  const bucketLeft=bucketExpanded?bucket.x-40:bucket.x;
  
  const bucketGrad=ctx.createLinearGradient(0,by,0,by+25);
  if(bucketExpanded){
    bucketGrad.addColorStop(0,"#88ff88"); bucketGrad.addColorStop(1,"#00cc00");
    ctx.shadowColor="#00ff00"; ctx.shadowBlur=25;
  }else{
    bucketGrad.addColorStop(0,"#66ff66"); bucketGrad.addColorStop(1,"#00aa00");
    ctx.shadowColor="#00ff00"; ctx.shadowBlur=12;
  }
  ctx.fillStyle=bucketGrad;
  ctx.fillRect(bucketLeft,by,currentBucketW,15);
  ctx.fillRect(bucketLeft,by,10,28);
  ctx.fillRect(bucketLeft+currentBucketW-10,by,10,28);
  ctx.shadowBlur=0;

  balls.forEach(b=>{
    b.vy+=GRAVITY*dt;
    b.x+=b.vx*dt;
    b.y+=b.vy*dt;
    b.vx*=Math.pow(REST,dt);
    b.vy*=Math.pow(REST,dt);
    if(b.portalCooldown>0)b.portalCooldown--;
    b.trail.push({x:b.x,y:b.y});
    if(b.trail.length>12)b.trail.shift();

    if(b.x<field.left()+b.r){b.x=field.left()+b.r;b.vx*=-1;beep(450,.04,"square");}
    if(b.x>field.right()-b.r){b.x=field.right()-b.r;b.vx*=-1;beep(450,.04,"square");}
    if(b.y<b.r){b.y=b.r;b.vy*=-1;beep(450,.04,"square");}

    portals.forEach(p=>{
      if(b.portalCooldown===0&&Math.hypot(b.x-p.x,b.y-p.y)<p.r){
        b.x=p.tx; b.y=p.ty;
        b.portalCooldown=30;
        portalUsesThisTurn++;
        justExitedPortal = true; // FOR ACH 9
        beep(1500,.15,"sine");
        for(let i=0;i<15;i++){
          particles.push({
            x:p.tx,y:p.ty, vx:(Math.random()-.5)*8, vy:(Math.random()-.5)*8,
            life:30, color:"#a020f0", size:3
          });
        }
      }
    });

    pegs.forEach(p=>{
      if(b.fireball){
        const dx=b.x-p.x,dy=b.y-p.y,d=Math.hypot(dx,dy);
        if(!p.hit&&d<50){
          p.hit=true;
          pegsHitThisTurn++;
          fireballHitsThisTurn++; // ACH 14
          if(fireballHitsThisTurn >= 15) unlockAchievement("ach_14");
          if(p.type!=="blue") specialTypesHitThisLevel.add(p.type);
          score+=p.type==="orange"?100:10;
          for(let i=0;i<20;i++){
            particles.push({
              x:p.x,y:p.y, vx:(Math.random()-.5)*8, vy:(Math.random()-.5)*8-2,
              life:45, color:"#ff3300", size:2
            });
          }
          updateUI();
        }
      }else{ collide(b,p); }
    });

    if(!b.bucketed&&b.y>=by&&b.y<=by+30&&b.x>=bucketLeft&&b.x<=bucketLeft+currentBucketW){
      b.bucketed=true;
      ballsLeft++;
      bucketVisitsThisTurn++;
      if(bucketExpanded) {
          bigBucketCatches++; // ACH 16
          if(bigBucketCatches >= 3) unlockAchievement("ach_16");
      }
      beep(1400,.2,"sine");
      bucketText.textContent="FREE BALL!";
      bucketText.style.color="#ffd700";
      bucketText.style.opacity=1;
      bucketText.style.transform="translateX(-50%) scale(1.2)";
      setTimeout(()=>{
        bucketText.style.opacity=0;
        bucketText.style.transform="translateX(-50%) scale(0)";
      },700);
      updateUI();
    }

    b.trail.forEach((t,i)=>{
      ctx.globalAlpha=(i+1)/b.trail.length*.6;
      ctx.beginPath(); ctx.arc(t.x,t.y,b.r,0,Math.PI*2);
      ctx.fillStyle=b.fireball?"#ff6633":"#ff6b6b";
      ctx.shadowColor=b.fireball?"#ff3300":"#ff0000";
      ctx.shadowBlur=10; ctx.fill(); ctx.shadowBlur=0;
    });
    ctx.globalAlpha=1;
    if(b.fireball){ ctx.shadowColor="#ff3300"; ctx.shadowBlur=25; }
    const grad=ctx.createRadialGradient(b.x-3,b.y-3,0,b.x,b.y,b.r);
    grad.addColorStop(0,b.fireball?"#ffaa66":"#ff8888");
    grad.addColorStop(.5,b.fireball?"#ff6633":"#ff4444");
    grad.addColorStop(1,b.fireball?"#ff0000":"#cc2222");
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    ctx.fillStyle=grad; ctx.fill(); ctx.shadowBlur=0;
  });

  if(balls.length&&balls[0].y>canvas.height+50){ endTurn(); }
  ctx.restore();
  requestAnimationFrame(loop);
}

function updateUI(){
  uiScore.textContent=Math.floor(score);
  uiOrange.textContent=pegs.filter(p=>p.type==="orange"&&!p.hit).length;
  uiLevel.textContent=level;
  ballsDisplay.innerHTML="";
  for(let i=0;i<10;i++){
    const d=document.createElement("div");
    d.className="ballIcon"+(i>=ballsLeft?" used":"");
    ballsDisplay.appendChild(d);
  }
  if(score>=10000)unlockAchievement("10k");
  if(score>=100000)unlockAchievement("100k");
}

function showOverlay(title){
  running=false;
  score+=ballsLeft*1000;
  overlayTitle.textContent=title;
  finalScore.textContent=Math.floor(score);
  overlay.style.display="flex";
  if(title.includes("COMPLETE")){ beep(1500,.3,"triangle"); }
}

function overlayAction(){
  overlay.style.display="none";
  if(overlayTitle.textContent.includes("COMPLETE")){
    level++; ballsLeft=10; running=true; canShoot=true; generateLevel(); loop();
  }else{
    score=0; ballsLeft=10; level=1; running=true; canShoot=true; generateLevel(); loop();
  }
}

function startGame(){
  menu.style.display="none";
  score=0; ballsLeft=10; level=1; running=true; generateLevel(); loop();
}

function unlockAchievement(id){
  const ach=ACHIEVEMENTS.find(a=>a.id===id);
  if(!ach||ach.unlocked)return;
  ach.unlocked=true;
  unlockedAchievements.push(id);
  try{ localStorage.setItem("peggle-achievements",JSON.stringify(unlockedAchievements)); }catch(e){}
  achievementTitle.textContent=ach.icon+" "+ach.name;
  achievementDesc.textContent=ach.desc;
  achievementEl.classList.add("show");
  beep(1600,.3,"triangle");
  setTimeout(()=>{ achievementEl.classList.remove("show"); },3500);
}

function showAchievements(){
  const achDiv=document.getElementById("achievements");
  if(achDiv.style.display==="block"){ achDiv.style.display="none"; return; }
  achDiv.innerHTML="<h2>üèÜ ACHIEVEMENTS üèÜ</h2>";
  ACHIEVEMENTS.forEach(a=>{
    const item=document.createElement("div");
    item.className="achievement-item"+(a.unlocked?" unlocked":"");
    item.innerHTML=`
      <div class="achievement-icon">${a.unlocked?a.icon:"üîí"}</div>
      <div class="achievement-info">
        <h4>${a.name}</h4>
        <p>${a.desc}</p>
      </div>`;
    achDiv.appendChild(item);
  });
  achDiv.style.display="block";
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j=Math.random()*(i+1)|0;
    [a[i],a[j]]=[a[j],a[i]];
  }
}

try{
  const saved=localStorage.getItem("peggle-achievements");
  if(saved){
    const ids=JSON.parse(saved);
    ACHIEVEMENTS.forEach(a=>{if(ids.includes(a.id))a.unlocked=true});
    unlockedAchievements=ids;
  }
}catch(e){}
</script>
</body>
</html>